<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হিজলী দিঘাপাড়া যুব সংঘ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root { --primary-color: #16a085; --secondary-color: #e74c3c; --light-gray: #f0f2f5; --dark-text: #2c3e50; --light-text: #666; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Hind Siliguri', sans-serif; margin: 0; background-color: var(--light-gray); color: var(--dark-text); padding-bottom: 80px; display: none; }
        header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; }
        header h1 { font-size: 1.6rem; margin: 0; }
        main { padding: 15px; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background-color: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        h2 { font-size: 1.4rem; text-align: center; margin-bottom: 20px; }
        
        .features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 768px) { .features-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .features-grid { grid-template-columns: 1fr; } }
        
        .feature-card-v2 { background-color: white; border-radius: 15px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; text-align: center; cursor: pointer; text-decoration: none; color: var(--dark-text); }
        .feature-card-v2-top { padding: 20px 15px; color: white; border-radius: 15px 15px 0 0; }
        .feature-card-v2-top i { font-size: 2.5rem; }
        .feature-card-v2-top h3 { margin: 10px 0 0; font-size: 1.1rem; }
        .feature-card-v2-bottom { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .feature-card-v2-bottom p { margin: 0; font-size: 0.9rem; color: var(--light-text); }
        
        .card-member .feature-card-v2-top { background-color: #6a1b9a; }
        .card-donation-list .feature-card-v2-top { background-color: #00897b; }
        .card-finance .feature-card-v2-top { background-color: #689f38; }
        .card-blood .feature-card-v2-top { background-color: #d32f2f; }
        .card-donate .feature-card-v2-top { background-color: #3498db; }
        .card-notice .feature-card-v2-top { background-color: #f39c12; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #95a5a6; font-size: 0.8rem; padding: 5px; cursor: pointer; flex-grow: 1; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .data-list .data-item { padding: 10px; border-bottom: 1px solid #eee; }
        .purpose-select { margin-left: 10px; padding: 5px; border-radius: 5px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-bar select, .search-bar { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        input, select, textarea, button { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; font-family: 'Hind Siliguri', sans-serif; }
        button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; }
        
        .member-list .member-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .member-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; position: relative; }
        .modal-content img { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px; border: 3px solid var(--primary-color); object-fit: cover; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }

        #profile-image-container { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; cursor: pointer; }
        #profile-image-container img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-color); }
        #profile-image-container .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        #profile-image-container:hover .overlay { opacity: 1; }
    </style>
</head>
<body>
    <header><h1>হিজলী দিঘাপাড়া যুব সংঘ</h1></header>
    <main>
        <div id="home-section" class="page active">
            <div class="card" style="text-align:center;"><h2>আসসালামু আলাইকুম ওয়া রাহমাতুল্লাহ</h2><p>আমাদের সংগঠনে আপনাকে স্বাগতম।</p></div>
            <div class="features-grid">
                <a class="feature-card-v2" onclick="showPage('member-section')"><div class="feature-card-v2-top card-member"><i class="fas fa-users"></i><h3>সদস্য তথ্য</h3></div><div class="feature-card-v2-bottom"><p>সদস্যদের তালিকা ও তথ্য</p></div></a>
                <a class="feature-card-v2" onclick="showPage('donation-section')"><div class="feature-card-v2-top card-donation-list"><i class="fas fa-hand-holding-heart"></i><h3>ডোনেশন লিস্ট</h3></div><div class="feature-card-v2-bottom"><p>সকল সদস্যদের অনুদান</p></div></a>
                <a class="feature-card-v2" onclick="showPage('finance-section')"><div class="feature-card-v2-top card-finance"><i class="fas fa-chart-line"></i><h3>আয়-ব্যয় হিসাব</h3></div><div class="feature-card-v2-bottom"><p>সংগঠনের মোট হিসাব</p></div></a>
                <a class="feature-card-v2" onclick="showPage('blood-section')"><div class="feature-card-v2-top card-blood"><i class="fas fa-droplet"></i><h3>ব্লাড গ্রুপ</h3></div><div class="feature-card-v2-bottom"><p>রক্তদাতার তালিকা</p></div></a>
                <a href="donate.html" class="feature-card-v2 card-donate"><div class="feature-card-v2-top"><i class="fas fa-donate"></i><h3>অনুদান পাঠান</h3></div><div class="feature-card-v2-bottom"><p>সংগঠনকে সাহায্য করুন</p></div></a>
                <a href="notices.html" class="feature-card-v2 card-notice"><div class="feature-card-v2-top"><i class="fas fa-bell"></i><h3>নোটিশ বোর্ড</h3></div><div class="feature-card-v2-bottom"><p>সাম্প্রতিক ঘোষণা দেখুন</p></div></a>
            </div>
        </div>

        <div id="member-section" class="page"><div class="card"><h2>সদস্য তালিকা</h2><input type="text" id="memberSearch" class="search-bar" placeholder="সদস্য খুঁজুন..."><div id="memberList" class="member-list"><p>লোড হচ্ছে...</p></div></div></div>
        <div id="donation-section" class="page"><div class="card"><h2>ডোনেশন তালিকা</h2><div class="filter-bar"><select id="donationSort"><option value="latest">সর্বশেষ</option><option value="ranking">সর্বোচ্চ দাতা</option></select></div><div id="donationList" class="data-list"><p>লোড হচ্ছে...</p></div></div></div>
        <div id="finance-section" class="page"><div class="card"><h2>আয়-ব্যয় হিসাব</h2><div class="filter-bar"><select id="financeMonthFilter"><option value="all">সর্বমোট হিসাব</option></select></div><div id="finance-summary"><p>লোড হচ্ছে...</p></div></div></div>
        <div id="blood-section" class="page"><div class="card"><h2>রক্তদাতার তালিকা</h2><div class="filter-bar"><select id="bloodGroupFilter"><option value="">সব গ্রুপ</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select><select id="bloodEligibilityFilter"><option value="all">সবাই</option><option value="eligible">রক্তদানে প্রস্তুত</option></select></div><div id="bloodList" class="data-list"><p>লোড হচ্ছে...</p></div></div></div>
        
        <div id="profile-section" class="page">
            <h2><i class="fas fa-user-edit"></i> আমার প্রোফাইল</h2>
            <div class="card">
                <h3>প্রোফাইল তথ্য</h3>
                <div id="profile-image-container">
                    <img id="profileImg" src="https://via.placeholder.com/120" alt="প্রোফাইল ছবি">
                    <div class="overlay"><i class="fas fa-camera"></i>&nbsp;<span>ছবি পরিবর্তন</span></div>
                </div>
                <form id="profileEditForm"><!-- Form fields will be loaded by JS --></form>
            </div>
            <div class="card">
                <h3>আমার ডোনেশন হিস্ট্রি</h3>
                <div id="myDonationHistory" class="data-list"><p>লোড হচ্ছে...</p></div>
            </div>
        </div>
        
        <div id="memberModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeModal('memberModal')">&times;</span><img id="modalImg" src=""><h3 id="modalName"></h3><table id="modalInfoTable"></table></div></div>
        <div id="photoUpdateModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeModal('photoUpdateModal')">&times;</span><h2>ছবি আপডেট করুন</h2><form id="photoUpdateForm"><input type="file" id="newProfilePhoto" accept="image/*" required><button type="submit">আপলোড করুন</button><p id="photoUploadStatus"></p></form></div></div>
    </main>
    <nav class="bottom-nav">
        <div class="nav-item active" data-page="home-section"><i class="fas fa-home"></i><span>হোম</span></div>
        <div class="nav-item" data-page="member-section"><i class="fas fa-users"></i><span>সদস্য</span></div>
        <div class="nav-item" data-page="donation-section"><i class="fas fa-hand-holding-heart"></i><span>ডোনেশন</span></div>
        <div class="nav-item" data-page="finance-section"><i class="fas fa-calculator"></i><span>হিসাব</span></div>
        <div class="nav-item" data-page="blood-section"><i class="fas fa-heart"></i><span>রক্ত</span></div>
        <div class="nav-item" id="profileNavButton" data-page="profile-section"><i class="fas fa-user-circle"></i><span>প্রোফাইল</span></div>
        <div class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>লগআউট</span></div>
    </nav>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDerc9e0-e7WBnkK2GoinFejp7zszXJ3Jc", authDomain: "songho-8ef5c.firebaseapp.com", projectId: "songho-8ef5c", storageBucket: "songho-8ef5c.appspot.com", messagingSenderId: "489031747232", appId: "1:489031747232:web:4c1cde63dabaa620ed2bc5", measurementId: "G-5NY15E3XJJ" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let membersData = [], allDonations = [], allExpenses = [];
    let isDataLoaded = { members: false, finances: false };
    const donationPurposes = { "samajik": "সামাজিক উন্নয়ন", "khela": "খেলাধুলা", "mosjid": "মসজিদ উন্নয়ন" };
    
    // Auth Management
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const profileNav = document.getElementById('profileNavButton');
            const logoutBtn = document.getElementById('logoutBtn');
            if (user.isAnonymous) {
                profileNav.style.display = 'none';
                logoutBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>লগইন</span>';
                logoutBtn.onclick = () => window.location.href = 'login.html';
            } else {
                const docSnap = await getDoc(doc(db, "members", user.uid));
                if (!docSnap.exists()) { window.location.replace('complete-profile.html'); return; }
                profileNav.style.display = 'flex';
                logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i><span>লগআউট</span>';
                logoutBtn.onclick = () => signOut(auth);
            }
            document.body.style.display = 'block';
        } else { window.location.replace('login.html'); }
    });
    
    // Page Navigation
    document.querySelectorAll('.nav-item').forEach(item => item.dataset.page && item.addEventListener('click', () => showPage(item.dataset.page)));

    window.showPage = async function(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId)?.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.nav-item[data-page="${pageId}"]`)?.classList.add('active');

        try {
            switch(pageId) {
                case 'member-section':
                case 'blood-section':
                    if (!isDataLoaded.members) {
                        const snapshot = await getDocs(query(collection(db, "members"), orderBy("name")));
                        membersData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        isDataLoaded.members = true;
                    }
                    if (pageId === 'member-section') renderMembers();
                    else renderBloodDonors();
                    break;
                case 'donation-section':
                case 'finance-section':
                    if(!isDataLoaded.finances) {
                        const [donationsSnapshot, expensesSnapshot] = await Promise.all([
                            getDocs(query(collection(db, "donations"), orderBy("date", "desc"))),
                            getDocs(query(collection(db, "expenses"), orderBy("date", "desc")))
                        ]);
                        allDonations = donationsSnapshot.docs.map(doc => ({id:doc.id, ...doc.data()}));
                        allExpenses = expensesSnapshot.docs.map(doc => ({id:doc.id, ...doc.data()}));
                        isDataLoaded.finances = true;
                    }
                    if (pageId === 'donation-section') renderDonations();
                    else renderFinance();
                    break;
                case 'profile-section':
                    if (!currentUser || currentUser.isAnonymous) break;
                    const userDoc = await getDoc(doc(db, "members", currentUser.uid));
                    renderProfileForm(userDoc.data());
                    await loadMyDonations();
                    break;
            }
        } catch (error) {
            console.error(`Error loading page ${pageId}:`, error);
            document.getElementById(pageId).innerHTML = `<div class="card" style="color:red;"><h3>এই পৃষ্ঠাটি লোড করা সম্ভব হয়নি।</h3><p>${error.message}</p></div>`;
        }
    }

    // Render Functions
    function renderMembers() {
        const memberList = document.getElementById('memberList');
        memberList.innerHTML = membersData.map(m => `
            <div class="member-item" onclick="showMemberDetails('${m.id}')">
                <img src="${m.img || 'https://via.placeholder.com/40'}" alt="${m.name}">
                <div>${m.name}</div>
            </div>`).join('');
    }

    function renderBloodDonors() {
        const willingMembers = membersData.filter(m => m.isWillingToDonate !== false);
        const bloodList = document.getElementById('bloodList');
        bloodList.innerHTML = willingMembers.map(d => `<div class="data-item">${d.name} - ${d.blood}</div>`).join('');
    }
    
    function renderDonations() { /* Donation render logic here */ }
    function renderFinance() { /* Finance render logic here */ }

    function renderProfileForm(data) {
        document.getElementById('profileImg').src = data.img || 'https://via.placeholder.com/120';
        const form = document.getElementById('profileEditForm');
        form.innerHTML = `
            <div class="form-group"><label>নাম:</label><input type="text" id="profileName" value="${data.name || ''}"></div>
            <div class="form-group"><label>ভবিষ্যতে রক্তদানে ইচ্ছুক?</label>
                <select id="isWillingToDonate">
                    <option value="true" ${data.isWillingToDonate !== false ? 'selected' : ''}>হ্যাঁ</option>
                    <option value="false" ${data.isWillingToDonate === false ? 'selected' : ''}>না</option>
                </select>
            </div>
            <button type="submit">আপডেট করুন</button>`;
        form.onsubmit = async (e) => {
            e.preventDefault();
            const newData = {
                name: document.getElementById('profileName').value,
                isWillingToDonate: document.getElementById('isWillingToDonate').value === 'true'
            };
            await updateDoc(doc(db, "members", currentUser.uid), newData);
            alert("প্রোফাইল আপডেট হয়েছে!");
            isDataLoaded.members = false;
        };
        document.getElementById('profile-image-container').onclick = () => openModal('photoUpdateModal');
    }

    async function loadMyDonations() {
        const historyDiv = document.getElementById('myDonationHistory');
        if (!currentUser || currentUser.isAnonymous) return;
        const q = query(collection(db, "donations"), where("userId", "==", currentUser.uid), orderBy("date", "desc"));
        const snapshot = await getDocs(q);
        historyDiv.innerHTML = snapshot.empty ? '<p>আপনি এখনো কোনো অনুদান দেননি।</p>' : '';
        let options = Object.entries(donationPurposes).map(([k, v]) => `<option value="${k}">${v}</option>`).join('');
        snapshot.forEach(doc => {
            const d = doc.data();
            const date = d.date ? new Date(d.date).toLocaleDateString('bn-BD') : 'N/A';
            let purposeHTML = d.purposeKey ? `<strong>উদ্দেশ্য:</strong> ${donationPurposes[d.purposeKey]}` : `<select class="purpose-select" onchange="updateDonationPurpose('${doc.id}', this.value)"><option value="">-- উদ্দেশ্য --</option>${options}</select>`;
            historyDiv.innerHTML += `<div class="data-item"><strong>পরিমাণ:</strong> ${d.amount} টাকা | <strong>তারিখ:</strong> ${date} | ${purposeHTML}</div>`;
        });
    }

    window.updateDonationPurpose = async (id, key) => {
        if (!key) return;
        await updateDoc(doc(db, "donations", id), { purposeKey: key });
        alert("উদ্দেশ্য আপডেট হয়েছে!");
        loadMyDonations();
    };
    
    // Modal & Helper Functions
    window.openModal = (modalId) => document.getElementById(modalId).style.display = "block";
    window.closeModal = (modalId) => document.getElementById(modalId).style.display = "none";

    window.showMemberDetails = (id) => {
        const member = membersData.find(m => m.id === id);
        if (!member) return;
        document.getElementById('modalImg').src = member.img || 'https://via.placeholder.com/100';
        document.getElementById('modalName').innerText = member.name;
        document.getElementById('modalInfoTable').innerHTML = `
            <tr><td>মোবাইল:</td><td>${member.phone || 'N/A'}</td></tr>
            <tr><td>রক্তের গ্রুপ:</td><td>${member.blood || 'N/A'}</td></tr>`;
        openModal('memberModal');
    };
</script>
</body>
</html>
