<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হিজলী দিঘাপাড়া যুব সংঘ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body { display: none; } 
        :root { --primary-color: #16a085; --secondary-color: #e74c3c; --light-gray: #f0f2f5; --dark-text: #2c3e50; --light-text: #666; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; margin: 0; background-color: var(--light-gray); color: var(--dark-text); padding-bottom: 80px; }
        header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; }
        header h1 { font-size: 1.6rem; margin: 0; }
        .page { display: none; padding: 15px; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        h2 { font-size: 1.4rem; text-align: center; margin-bottom: 20px; }
        .features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 768px) { .features-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .features-grid { grid-template-columns: 1fr; } }
        .feature-card-v2 { background-color: white; border-radius: 15px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; text-align: center; cursor: pointer; text-decoration: none; color: var(--dark-text); }
        .feature-card-v2-top { padding: 20px 15px; color: white; border-radius: 15px 15px 0 0; }
        .feature-card-v2-top i { font-size: 2.5rem; }
        .feature-card-v2-top h3 { margin: 10px 0 0; font-size: 1.1rem; }
        .feature-card-v2-bottom { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .feature-card-v2-bottom p { margin: 0; font-size: 0.9rem; color: var(--light-text); }
        .card-member .feature-card-v2-top { background-color: #6a1b9a; }
        .card-donation-list .feature-card-v2-top { background-color: #00897b; }
        .card-finance .feature-card-v2-top { background-color: #689f38; }
        .card-blood .feature-card-v2-top { background-color: #d32f2f; }
        .card-donate .feature-card-v2-top { background-color: #3498db; }
        .card-notice .feature-card-v2-top { background-color: #f39c12; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #95a5a6; font-size: 0.8rem; padding: 5px; cursor: pointer; flex-grow: 1; }
        .nav-item.active { color: var(--primary-color); }
        .purpose-select { margin-left: 10px; padding: 5px; border-radius: 5px; }
        .data-list .data-item { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <header>
        <h1>হিজলী দিঘাপাড়া যুব সংঘ</h1>
    </header>
    <main>
        <div id="home-section" class="page active">
            <div class="card" style="text-align:center;"><h2>আসসালামু আলাইকুম ওয়া রাহমাতুল্লাহ</h2><p>আমাদের সংগঠনে আপনাকে স্বাগতম।</p></div>
            <div class="features-grid">
                <a class="feature-card-v2 card-member" onclick="showPage('member-section')"><div class="feature-card-v2-top"><i class="fas fa-users"></i><h3>সদস্য তথ্য</h3></div><div class="feature-card-v2-bottom"><p>সদস্যদের তালিকা ও তথ্য</p></div></a>
                <a class="feature-card-v2 card-donation-list" onclick="showPage('donation-section')"><div class="feature-card-v2-top"><i class="fas fa-hand-holding-heart"></i><h3>ডোনেশন লিস্ট</h3></div><div class="feature-card-v2-bottom"><p>সকল সদস্যদের অনুদান</p></div></a>
                <a class="feature-card-v2 card-finance" onclick="showPage('finance-section')"><div class="feature-card-v2-top"><i class="fas fa-chart-line"></i><h3>আয়-ব্যয় হিসাব</h3></div><div class="feature-card-v2-bottom"><p>সংগঠনের মোট হিসাব</p></div></a>
                <a class="feature-card-v2 card-blood" onclick="showPage('blood-section')"><div class="feature-card-v2-top"><i class="fas fa-droplet"></i><h3>ব্লাড গ্রুপ</h3></div><div class="feature-card-v2-bottom"><p>রক্তদাতার তালিকা</p></div></a>
                <a href="donate.html" class="feature-card-v2 card-donate"><div class="feature-card-v2-top"><i class="fas fa-donate"></i><h3>অনুদান পাঠান</h3></div><div class="feature-card-v2-bottom"><p>সংগঠনকে সাহায্য করুন</p></div></a>
                <a href="notices.html" class="feature-card-v2 card-notice"><div class="feature-card-v2-top"><i class="fas fa-bell"></i><h3>নোটিশ বোর্ড</h3></div><div class="feature-card-v2-bottom"><p>সাম্প্রতিক ঘোষণা দেখুন</p></div></a>
            </div>
        </div>
        <div id="profile-section" class="page">
            <h2><i class="fas fa-user-edit"></i> আমার প্রোফাইল</h2>
            <div class="card">
                <h3>আমার ডোনেশন হিস্ট্রি</h3>
                <div id="myDonationHistory" class="data-list"><p>লোড হচ্ছে...</p></div>
            </div>
        </div>
        <!-- Other pages will be loaded here dynamically -->
    </main>
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home-section')"><i class="fas fa-home"></i><span>হোম</span></div>
        <div class="nav-item" onclick="showPage('member-section')"><i class="fas fa-users"></i><span>সদস্য</span></div>
        <div class="nav-item" onclick="showPage('donation-section')"><i class="fas fa-hand-holding-heart"></i><span>ডোনেশন</span></div>
        <div class="nav-item" onclick="showPage('finance-section')"><i class="fas fa-calculator"></i><span>হিসাব</span></div>
        <div class="nav-item" onclick="showPage('blood-section')"><i class="fas fa-heart"></i><span>রক্ত</span></div>
        <div class="nav-item" id="profileNavButton" onclick="showPage('profile-section')"><i class="fas fa-user-circle"></i><span>প্রোফাইল</span></div>
        <div class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>লগআউট</span></div>
    </nav>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDerc9e0-e7WBnkK2GoinFejp7zszXJ3Jc", authDomain: "songho-8ef5c.firebaseapp.com", projectId: "songho-8ef5c", storageBucket: "songho-8ef5c.appspot.com", messagingSenderId: "489031747232", appId: "1:489031747232:web:4c1cde63dabaa620ed2bc5", measurementId: "G-5NY15E3XJJ" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let membersData = [];
    const donationPurposes = { "samajik": "সামাজিক উন্নয়ন", "khela": "খেলাধুলা", "mosjid": "মসজিদ উন্নয়ন" };
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            if (user.isAnonymous) {
                document.getElementById('profileNavButton').style.display = 'none';
                document.getElementById('logoutBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i><span>লগইন</span>';
            } else {
                const docSnap = await getDoc(doc(db, "members", user.uid));
                if (!docSnap.exists()) { window.location.replace('complete-profile.html'); return; }
                await loadMyDonations();
            }
            document.body.style.display = 'block';
        } else { window.location.replace('login.html'); }
    });
    
    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

    async function loadBloodDonors() {
        const bloodListContainer = document.querySelector('#blood-section .card'); // Assuming a container
        if (!membersData.length) {
            const membersSnapshot = await getDocs(collection(db, "members"));
            membersData = membersSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        }
        
        // Bug Fix: Filter out members who are not willing to donate first.
        let willingMembers = membersData.filter(m => m.isWillingToDonate !== false);

        // ... rest of the filtering logic ...
        // This function now just renders the list based on already fetched membersData.
    }
    
    async function loadMyDonations() {
        const historyDiv = document.getElementById('myDonationHistory');
        if (!currentUser || currentUser.isAnonymous) {
            historyDiv.innerHTML = '<p>এই ফিচারটি ব্যবহার করতে লগইন করুন।</p>'; return;
        }
        const q = query(collection(db, "donations"), where("userId", "==", currentUser.uid), orderBy("date", "desc"));
        const querySnapshot = await getDocs(q);
        
        historyDiv.innerHTML = '';
        if (querySnapshot.empty) {
            historyDiv.innerHTML = '<p>আপনি এখনো কোনো অনুদান দেননি।</p>'; return;
        }
        let purposeOptions = Object.entries(donationPurposes).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');

        querySnapshot.forEach(doc => {
            const donation = doc.data();
            const date = donation.date ? new Date(donation.date).toLocaleDateString('bn-BD') : 'N/A';
            let purposeHTML = donation.purposeKey 
                ? `<strong>উদ্দেশ্য:</strong> ${donationPurposes[donation.purposeKey]}`
                : `<select class="purpose-select" onchange="window.updateDonationPurpose('${doc.id}', this.value)">
                      <option value="">-- উদ্দেশ্য নির্বাচন করুন --</option>${purposeOptions}
                   </select>`;
            
            historyDiv.innerHTML += `<div class="data-item"><strong>পরিমাণ:</strong> ${donation.amount} টাকা | <strong>তারিখ:</strong> ${date} | ${purposeHTML}</div>`;
        });
    }

    window.updateDonationPurpose = async function(donationId, purposeKey) {
        if (!purposeKey) return;
        try {
            await updateDoc(doc(db, "donations", donationId), { purposeKey: purposeKey });
            alert("উদ্দেশ্য সফলভাবে আপডেট করা হয়েছে!");
            loadMyDonations();
        } catch (error) {
            alert("আপডেট করতে সমস্যা হয়েছে: " + error.message);
        }
    }

    window.showPage = function(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        let pageElement = document.getElementById(pageId);
        if (pageElement) {
            pageElement.classList.add('active');
        }
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const navButton = document.querySelector(`.nav-item[onclick*="'${pageId}'"]`);
        if(navButton) navButton.classList.add('active');
    }
</script>
</body>
</html>
