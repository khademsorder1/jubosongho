<!-- FILE: admin.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল - যুব সংঘ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; margin: 0; background-color: #1a1c23; color: #e0e6ed; display: none; }
        
        /* Layout */
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: #24262d; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { color: #009688; margin-bottom: 30px; text-align: center; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; transition: 0.3s; color: #9e9e9e; display: flex; align-items: center; }
        .menu-item:hover, .menu-item.active { background: #009688; color: white; }
        .menu-item i { margin-right: 10px; width: 20px; text-align: center; }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        /* Components */
        .card { background: #24262d; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #24262d; padding: 20px; border-radius: 10px; border-left: 4px solid #009688; }
        .stat-card h3 { margin: 0; font-size: 2rem; color: #fff; } .stat-card p { margin: 0; color: #7f8c8d; }
        
        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #009688; } tr:hover { background: #2c2f38; }
        
        /* Forms */
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #1a1c23; border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; }
        button.action-btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .btn-edit { background: #ffca28; color: #333; } .btn-delete { background: #e74c3c; color: white; } .btn-view { background: #3498db; color: white; } .btn-add { background: #009688; color: white; width: 100%; padding: 12px; }
        
        /* Pending Cards */
        .pending-card { background: #2c2f38; border: 1px solid #444; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .pending-info { flex: 1; }
        .pending-actions { display: flex; gap: 10px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #24262d; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 20px; color: #ccc; }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container { flex-direction: column; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; box-sizing: border-box; }
            .menu-item { white-space: nowrap; margin-right: 10px; }
        }
    </style>
</head>
<body>
    <div id="loginSection" style="display:flex;height:100vh;justify-content:center;align-items:center;background:#1a1c23;">
        <div class="card" style="width:300px;text-align:center;">
            <h2 style="color:#009688;">অ্যাডমিন লগইন</h2>
            <button onclick="login()" class="btn-add">গুগল দিয়ে লগইন করুন</button>
        </div>
    </div>

    <div id="adminPanel" class="admin-container" style="display:none;">
        <div class="sidebar">
            <h2>যুব সংঘ</h2>
            <div class="menu-item active" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt"></i> ড্যাশবোর্ড</div>
            <div class="menu-item" onclick="showTab('members')"><i class="fas fa-users"></i> সদস্য</div>
            <div class="menu-item" onclick="showTab('finance')"><i class="fas fa-coins"></i> আয়-ব্যয়</div>
            <div class="menu-item" onclick="showTab('pending')"><i class="fas fa-user-check"></i> ভেরিফিকেশন</div>
            <div class="menu-item" onclick="showTab('notices')"><i class="fas fa-bullhorn"></i> নোটিশ</div>
            <div class="menu-item" onclick="showTab('settings')"><i class="fas fa-cogs"></i> সেটিংস</div>
        </div>
        
        <div class="content">
            <div class="header">
                <h2 id="pageTitle">ড্যাশবোর্ড</h2>
                <button class="logout-btn" onclick="logout()">লগআউট</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="stat-grid">
                    <div class="stat-card"><h3><i class="fas fa-users"></i> <span id="dashMembers">0</span></h3><p>মোট সদস্য</p></div>
                    <div class="stat-card" style="border-color:#ffca28;"><h3><i class="fas fa-hand-holding-dollar"></i> <span id="dashPending">0</span></h3><p>অপেক্ষমাণ ডোনেশন</p></div>
                    <div class="stat-card" style="border-color:#2ecc71;"><h3>৳<span id="dashBalance">0</span></h3><p>বর্তমান ব্যালেন্স</p></div>
                </div>
            </div>

            <!-- Members Tab -->
            <div id="members" class="tab-content" style="display:none;">
                <div class="card">
                    <div style="display:flex;gap:10px;margin-bottom:15px;">
                        <input type="text" id="adminMemSearch" placeholder="নাম বা ফোন নম্বর দিয়ে খুঁজুন..." onkeyup="filterMembers()">
                        <button class="action-btn btn-add" style="width:auto;" onclick="openModal('addMemberModal')">নতুন সদস্য</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead><tr><th>ছবি</th><th>নাম</th><th>ফোন</th><th>রক্ত</th><th>একশন</th></tr></thead>
                            <tbody id="adminMemberList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Finance Tab -->
            <div id="finance" class="tab-content" style="display:none;">
                <div class="stat-grid">
                    <div class="stat-card" style="border-color:#2ecc71;"><h3>৳<span id="finIncome">0</span></h3><p>মোট আয়</p></div>
                    <div class="stat-card" style="border-color:#e74c3c;"><h3>৳<span id="finExpense">0</span></h3><p>মোট ব্যয়</p></div>
                </div>
                <div class="card">
                    <h3>নতুন খরচ যোগ করুন</h3>
                    <form id="addExpenseForm">
                        <input type="number" id="expAmount" placeholder="পরিমাণ" required>
                        <select id="expPurpose" required><option value="অন্যান্য">খাত নির্বাচন করুন</option><option value="সামাজিক উন্নয়ন">সামাজিক উন্নয়ন</option><option value="ঈদ অনুষ্ঠান">ঈদ অনুষ্ঠান</option><option value="খেলাধুলা">খেলাধুলা</option><option value="মসজিদ">মসজিদ</option><option value="মাদ্রাসা">মাদ্রাসা</option><option value="সাধারণ তহবিল">সাধারণ তহবিল</option></select>
                        <input type="text" id="expDesc" placeholder="বিবরণ" required>
                        <input type="date" id="expDate" required>
                        <button type="submit" class="btn-add">খরচ যুক্ত করুন</button>
                    </form>
                </div>
            </div>

            <!-- Pending Verification Tab -->
            <div id="pending" class="tab-content" style="display:none;">
                <div id="pendingList"></div>
            </div>

            <!-- Notices Tab -->
            <div id="notices" class="tab-content" style="display:none;">
                <div class="card">
                    <h3>নতুন নোটিশ</h3>
                    <form id="addNoticeForm">
                        <input type="text" id="noticeTitle" placeholder="শিরোনাম" required>
                        <input type="date" id="noticeDate" required>
                        <button type="submit" class="btn-add">প্রকাশ করুন</button>
                    </form>
                </div>
                <div id="adminNoticeList" class="card"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content" style="display:none;">
                <div class="card">
                    <h3>পেমেন্ট নাম্বার পরিবর্তন</h3>
                    <form id="settingsForm">
                        <label>বিকাশ নাম্বার:</label><input type="text" id="setBkash">
                        <label>নগদ নাম্বার:</label><input type="text" id="setNagad">
                        <button type="submit" class="btn-add">সংরক্ষণ করুন</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addMemberModal')">&times;</span>
            <h3>সদস্য যোগ/এডিট</h3>
            <form id="adminMemberForm">
                <input type="hidden" id="editMemId">
                <input type="text" id="memName" placeholder="নাম" required>
                <input type="text" id="memPhone" placeholder="ফোন (+880 ছাড়া)" required>
                <select id="memBlood"><option value="">রক্তের গ্রুপ</option><option value="A+">A+</option><option value="B+">B+</option><option value="O+">O+</option><option value="AB+">AB+</option></select>
                <input type="text" id="memLoc" placeholder="ঠিকানা">
                <button type="submit" class="btn-add">সেভ করুন</button>
            </form>
        </div>
    </div>
    
    <div id="viewProofModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <span class="close-modal" onclick="closeModal('viewProofModal')">&times;</span>
            <img id="proofImgDisplay" src="" style="max-width:100%;max-height:400px;border-radius:10px;">
            <p id="proofTxInfo"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, deleteDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDerc9e0-e7WBnkK2GoinFejp7zszXJ3Jc", authDomain: "songho-8ef5c.firebaseapp.com", projectId: "songho-8ef5c", storageBucket: "songho-8ef5c.appspot.com", messagingSenderId: "489031747232", appId: "1:489031747232:web:4c1cde63dabaa620ed2bc5", measurementId: "G-5NY15E3XJJ" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        
        let members=[], donations=[], expenses=[], pendings=[], notices=[];

        // Login Logic
        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            // SIMPLE SECURITY: Replace this list with real admin emails
            const allowedAdmins = ["your-email@gmail.com", "admin2@gmail.com"]; 
            
            if (user) {
                // For demo, allowing everyone. In production, uncomment below:
                // if(!allowedAdmins.includes(user.email)) { alert('Access Denied'); signOut(auth); return; }
                
                document.getElementById('loginSection').style.display='none';
                document.getElementById('adminPanel').style.display='flex';
                loadAllData();
            } else {
                document.getElementById('loginSection').style.display='flex';
                document.getElementById('adminPanel').style.display='none';
            }
        });

        // Tabs
        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(d=>d.style.display='none');
            document.getElementById(id).style.display='block';
            document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('pageTitle').innerText = event.currentTarget.innerText;
        }

        // Data Loading
        async function loadAllData() {
            const [m,d,e,p,n,s] = await Promise.all([
                getDocs(collection(db,"members")),
                getDocs(collection(db,"donations")),
                getDocs(collection(db,"expenses")),
                getDocs(collection(db,"pending_donations")),
                getDocs(query(collection(db,"notices"), orderBy("date","desc"))),
                getDoc(doc(db,"settings","payment"))
            ]);

            members = m.docs.map(x=>({id:x.id, ...x.data()}));
            donations = d.docs.map(x=>({id:x.id, ...x.data()}));
            expenses = e.docs.map(x=>({id:x.id, ...x.data()}));
            pendings = p.docs.map(x=>({id:x.id, ...x.data()}));
            notices = n.docs.map(x=>({id:x.id, ...x.data()}));

            // Dashboard Stats
            document.getElementById('dashMembers').innerText = members.length;
            document.getElementById('dashPending').innerText = pendings.length;
            const inc = donations.reduce((a,b)=>a+Number(b.amount),0);
            const exp = expenses.reduce((a,b)=>a+Number(b.amount),0);
            document.getElementById('dashBalance').innerText = (inc - exp).toLocaleString('bn-BD');
            document.getElementById('finIncome').innerText = inc.toLocaleString('bn-BD');
            document.getElementById('finExpense').innerText = exp.toLocaleString('bn-BD');

            if(s.exists()){
                document.getElementById('setBkash').value = s.data().bkash;
                document.getElementById('setNagad').value = s.data().nagad;
            }

            renderMembers();
            renderPending();
            renderNotices();
        }

        // 1. Members Management
        function renderMembers() {
            const tbody = document.getElementById('adminMemberList'); tbody.innerHTML='';
            members.forEach(m => {
                tbody.innerHTML += `<tr>
                    <td><img src="${m.img||'https://via.placeholder.com/40'}" style="width:40px;height:40px;border-radius:50%;"></td>
                    <td>${m.name}</td><td>${m.phone}</td><td>${m.blood||'-'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editMember('${m.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteItem('members','${m.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }
        window.filterMembers = () => {
            const q = document.getElementById('adminMemSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#adminMemberList tr');
            rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
        }
        window.editMember = (id) => {
            const m = members.find(x=>x.id===id);
            document.getElementById('editMemId').value=id; document.getElementById('memName').value=m.name;
            document.getElementById('memPhone').value=m.phone.replace('+880',''); document.getElementById('memBlood').value=m.blood;
            document.getElementById('memLoc').value=m.location; openModal('addMemberModal');
        }
        document.getElementById('adminMemberForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const id = document.getElementById('editMemId').value;
            const data = {
                name: document.getElementById('memName').value,
                phone: '+880'+document.getElementById('memPhone').value,
                blood: document.getElementById('memBlood').value,
                location: document.getElementById('memLoc').value
            };
            if(id) await updateDoc(doc(db,"members",id), data);
            else await addDoc(collection(db,"members"), {...data, img:'', income:'', lastDonationDate:''});
            closeModal('addMemberModal'); loadAllData();
        });

        // 2. Finance (Expense)
        document.getElementById('addExpenseForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await addDoc(collection(db,"expenses"), {
                amount: document.getElementById('expAmount').value,
                purposeKey: document.getElementById('expPurpose').value,
                description: document.getElementById('expDesc').value,
                date: document.getElementById('expDate').value
            });
            alert('খরচ যুক্ত হয়েছে'); e.target.reset(); loadAllData();
        });

        // 3. Pending Verification
        function renderPending() {
            const div = document.getElementById('pendingList'); div.innerHTML='';
            if(pendings.length===0) div.innerHTML='<p>কোনো অপেক্ষমাণ ডোনেশন নেই।</p>';
            pendings.forEach(p => {
                div.innerHTML += `<div class="pending-card">
                    <div class="pending-info">
                        <strong>${p.userName}</strong> (৳${p.amount})<br>
                        <small>${p.paymentMethod} - ${p.transactionInfo}</small><br>
                        <small>উদ্দেশ্য: ${p.purposeKey}</small>
                    </div>
                    <div class="pending-actions">
                        ${p.proofImageUrl ? `<button class="action-btn btn-view" onclick="viewProof('${p.proofImageUrl}','${p.transactionInfo}')">প্রুফ</button>` : ''}
                        <button class="action-btn btn-add" onclick="approveDonation('${p.id}')">Approve</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('pending_donations','${p.id}')">Reject</button>
                    </div>
                </div>`;
            });
        }
        window.viewProof = (url, tx) => {
            document.getElementById('proofImgDisplay').src = url;
            document.getElementById('proofTxInfo').innerText = tx;
            openModal('viewProofModal');
        }
        window.approveDonation = async (id) => {
            const p = pendings.find(x=>x.id===id);
            // Move to donations
            await addDoc(collection(db,"donations"), { ...p, status:'approved' });
            // Delete from pending
            await deleteDoc(doc(db,"pending_donations", id));
            // Update user last donation date (Simple Logic)
            if(p.userId) {
                await updateDoc(doc(db,"members",p.userId), { lastDonationDate: p.date });
            }
            alert('Approve হয়েছে!'); loadAllData();
        }

        // 4. Notices
        function renderNotices() {
            const div = document.getElementById('adminNoticeList'); div.innerHTML='';
            notices.forEach(n => {
                div.innerHTML += `<div class="card" style="padding:10px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;">
                        <b>${n.title}</b> <small>${n.date}</small>
                        <button class="action-btn btn-delete" onclick="deleteItem('notices','${n.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }
        document.getElementById('addNoticeForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await addDoc(collection(db,"notices"), {
                title: document.getElementById('noticeTitle').value,
                date: document.getElementById('noticeDate').value
            });
            e.target.reset(); loadAllData();
        });

        // 5. Settings
        document.getElementById('settingsForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await setDoc(doc(db,"settings","payment"), {
                bkash: document.getElementById('setBkash').value,
                nagad: document.getElementById('setNagad').value
            });
            alert('আপডেট হয়েছে!');
        });

        // Utilities
        window.deleteItem = async (coll, id) => {
            if(confirm('আপনি কি নিশ্চিত?')) {
                await deleteDoc(doc(db, coll, id));
                loadAllData();
            }
        }
        window.openModal = (id) => document.getElementById(id).style.display='flex';
        window.closeModal = (id) => document.getElementById(id).style.display='none';

    </script>
</body>
</html>
